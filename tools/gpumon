#!/bin/bash

duration="${1:-1}"

tmpf=$(mktemp)
dcgmi dmon -l &> $tmpf

metrics=(
  ^name
  pci_busid
  sm_clock
  memory_clock
  gpu_temp
  memory_temp
  enforced_power_limit
  power_usage
  gpu_utilization
  tensor_imma_active #IMMA(Integer Matrix Multiply-Accumulate): INT4,INT8
  tensor_hmma_active #HMMA(Half-precision Matrix Multiply-Accumulate): FP16,BF16,TF32,FP8
  fp64_active
  fp32_active
  mem_copy_utilization
  fb_total
  fb_free
  fb_used
  #nvlink_bandwidth_l[0-9]
  #nvlink_bandwidth_l[0-9][0-9]
  nvlink_bandwidth_total
  nvlink.*error.*total*
  ecc_sbe_volatile_total
  ecc_dbe_volatile_total
  ecc_sbe_aggregate_total
  ecc_dbe_aggregate_total
  xid_errors
  #serial_number
)
dcgmi dmon -c 1 -e $(dcgmi dmon -l|grep -e tensor -e fp64_active -e fp32_active|awk '{print $NF}'|paste -s -d',') &>/dev/null
ret=$?
sensors=($(
for m in ${metrics[@]}; do
  if [ $ret -ne 0 ] && [[ $m == tensor* || $m == fp64_active || $m == fp32_active ]]; then
    continue
  fi
  #echo $m $(awk "/${m} /{print \$NF}" $tmpf)
  echo $(awk "/${m} /{print \$NF}" $tmpf)
done
))
rm -f $tmpf

declare -A port_rcv_data  port_rcv_data2
declare -A port_xmit_data port_xmit_data2
nics=($(for i in /sys/class/infiniband/*; do [ -e $i/device/hwmon ] && echo ${i##*/}; done |sort -t '_' -k1,1 -k2n,2))
##echo ${nics[@]}|tr ' ' '\n'|xargs -P 4 -I {} mlxlink -d {} -p 1 --pc &>/dev/null
for d in ${nics[@]}; do
  if [ -f /sys/class/infiniband/${d}/ports/1/counters/port_rcv_data ]; then
    port_rcv_data[$d]=$(</sys/class/infiniband/${d}/ports/1/counters/port_rcv_data)
    port_xmit_data[$d]=$(</sys/class/infiniband/${d}/ports/1/counters/port_xmit_data)
  fi
done
## Main
header="$(dcgmi dmon -c 1 -e $(echo ${sensors[@]}|tr ' ' ',') | head -n 1|tr -s ' ') | $(echo ${nics[*]}|tr ' ' '\n'|xargs -I {} echo {}:RMB {}:TMB|paste -s -d ' ')"
i=0
while :; do
  if [ $[i%10] -eq 0 ]; then
    printf "%25s %s\n" TIMESTAMP "$header"
  fi
  ts="$(date -Is)"
  for d in ${nics[@]}; do
    if [ -f /sys/class/infiniband/${d}/ports/1/counters/port_rcv_data ]; then
      port_rcv_data2[$d]=$(</sys/class/infiniband/${d}/ports/1/counters/port_rcv_data)
      port_xmit_data2[$d]=$(</sys/class/infiniband/${d}/ports/1/counters/port_xmit_data)
    fi
  done
  ib_ret=($(
  for d in ${nics[@]}; do
     echo "$[(${port_rcv_data2[$d]}-${port_rcv_data[${d}]})*4/1024/1024/$duration] $[(${port_xmit_data2[${d}]}-${port_xmit_data[${d}]})*4/1024/1024/$duration]"
  done 
  ))
  dcgmi dmon -c 1 -d $[1000*$duration] -e $(echo ${sensors[@]}|tr ' ' ',') \
    | tail -n +3 | tr -s ' ' | sed -e 's#GPU \([0-9]\)#GPU_\1#g' -e 's#NVIDIA #NVIDIA_#g' | while read line; do
    echo $ts $line \| ${ib_ret[*]}
  done
  sleep $duration
  i=$[i+1]
  for d in ${!port_rcv_data[@]}; do
    port_rcv_data[$d]=${port_rcv_data2[$d]}
    port_xmit_data[$d]=${port_xmit_data2[$d]}
  done
done

# cat log.txt | grep GPU_0 | grep -v TIMESTAMP|awk '{print $9}'| gnuplot -e "set term dumb size 300,50; set xtics 50; plot '-' with linespoints"
